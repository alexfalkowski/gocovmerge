[![CircleCI](https://circleci.com/gh/alexfalkowski/gocovmerge.svg?style=svg)](https://circleci.com/gh/alexfalkowski/gocovmerge)

# gocovmerge

`gocovmerge` is a small Go CLI tool that merges multiple Go coverage profiles (generated by `go test -coverprofile`) into a single profile.

This is useful when you run tests in multiple packages, shards, or jobs and want one combined `cover.out` for reporting.

## Install

### With `go install`

```bash
go install github.com/alexfalkowski/gocovmerge/v2@latest
```

Ensure `$(go env GOPATH)/bin` is on your `PATH`, then run:

```bash
gocovmerge -help
```

### From source

```bash
git clone https://github.com/alexfalkowski/gocovmerge.git
cd gocovmerge
go build -mod=vendor -o gocovmerge .
./gocovmerge -help
```

## Usage

```bash
gocovmerge -help

Usage of gocovmerge:
  -d string
        directory of files (if missing paths passed in)
  -o string
        output file (if missing stdout)
  -p string
        pattern to filter directory (if missing all files)
```

### Inputs: `-d` vs positional args

`gocovmerge` chooses input files like this:

- If `-d` is provided (non-empty), it **recursively walks** that directory and merges **all files** it finds.
  - If `-p` is also provided, it is treated as a **regular expression** and matched against the walked file path. Only matching files are included.
- If `-d` is **not** provided, it merges the remaining **positional arguments** as explicit coverage profile paths.

Examples:

Merge explicit files:

```bash
gocovmerge ./pkg1/cover.out ./pkg2/cover.out > cover.out
```

Merge all files under a directory:

```bash
gocovmerge -d ./coverage > cover.out
```

Merge all files under a directory that match a regexp:

```bash
# example: only include files ending in ".cov"
gocovmerge -d ./coverage -p '.*\.cov$' > cover.out
```

### Output: `-o` vs stdout

- If `-o` is provided, output is written to that file.
- If `-o` is not provided, output is written to stdout.

Examples:

Write to a file:

```bash
gocovmerge -o cover.out ./pkg1/cover.out ./pkg2/cover.out
```

Pipe to another command:

```bash
gocovmerge -d ./coverage | go tool cover -func=-
```

## End-to-end examples

### Merge package coverprofiles into one and view totals

```bash
go test ./... -coverprofile=cover.out -covermode=atomic
# (This produces one file already; shown for context.)

# If you instead have multiple profiles:
gocovmerge -d ./coverage -o merged.out
go tool cover -func=merged.out
```

### Typical CI: shards/jobs produce separate profiles

Suppose you have files like:

- `coverage/shard-1.out`
- `coverage/shard-2.out`
- `coverage/shard-3.out`

Then:

```bash
gocovmerge -d coverage -o cover.out
go tool cover -func=cover.out
```

## Important constraints / failure modes

### Same source code required

You can only merge profiles that were generated from the **same source code revision**.

If profiles refer to different versions of the same file, block boundaries may differ and merging can fail.

### Coverage modes must match

Profiles must use the same coverage mode (`set`, `count`, or `atomic`).

If you mix modes (for example, one profile generated with `-covermode=set` and another with `-covermode=atomic`), merging fails.

Tip: pick a single mode in your test runs, e.g.:

```bash
go test ./... -covermode=atomic -coverprofile=...
```

### Overlapping/incompatible blocks

If two profiles contain blocks for the same file that overlap in an incompatible way (different end positions for the same start, or blocks that nest/overlap unexpectedly), `gocovmerge` exits non-zero with an error.

### Empty input

If you pass no files (or your `-d`/`-p` combination matches nothing), there are no profiles to write and the command fails.

## Notes

- The merged output is a standard Go coverage profile: a single `mode: ...` header line followed by block lines.
- Merging is performed per `Profile.FileName`; within a file:
  - `set` mode merges counts using bitwise OR.
  - `count` and `atomic` modes merge counts by summing.